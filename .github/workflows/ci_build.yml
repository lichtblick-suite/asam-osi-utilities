# SPDX-License-Identifier: MPL-2.0
# SPDX-FileCopyrightText: Copyright (c) 2026, Bayerische Motoren Werke Aktiengesellschaft (BMW AG)

name: Build

on:
  workflow_call:

jobs:
  # ===========================================================================
  # Ubuntu with system packages (compatibility path)
  # ===========================================================================
  ubuntu:
    name: Ubuntu ${{ matrix.ubuntu }} (${{ matrix.compiler }}, system-compat)
    runs-on: ubuntu-${{ matrix.ubuntu }}
    strategy:
      fail-fast: false
      matrix:
        ubuntu: ['22.04', '24.04']
        compiler: [gcc, clang]
        include:
          - compiler: gcc
            cc: gcc
            cxx: g++
          - compiler: clang
            cc: clang
            cxx: clang++

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          YQ_VERSION=v4.52.2
          sudo curl -L -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq -r '.ci_jobs.ubuntu_build.apt' .github/dependencies.yml | xargs sudo apt-get install -y

      - name: Configure CMake
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: cmake --preset base -DBUILD_TESTING=ON -DCODE_COVERAGE=${{ matrix.compiler == 'gcc' && 'ON' || 'OFF' }}

      - name: Report protobuf linkage (system/base)
        run: |
          echo "FIND_PACKAGE_MESSAGE_DETAILS_Protobuf:"
          grep -E '^FIND_PACKAGE_MESSAGE_DETAILS_Protobuf:INTERNAL=' build/CMakeCache.txt || true

      - name: Build
        run: cmake --build --preset base --parallel $(nproc)

      - name: Run Tests
        working-directory: build
        run: ctest --output-on-failure --parallel $(nproc)

      - name: Generate Coverage Report
        if: matrix.compiler == 'gcc' && matrix.ubuntu == '24.04'
        run: gcovr -r . build --xml -o coverage.xml

      - name: Upload Coverage
        if: matrix.compiler == 'gcc' && matrix.ubuntu == '24.04'
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          fail_ci_if_error: false

  # ===========================================================================
  # Ubuntu with vcpkg
  # ===========================================================================
  ubuntu-vcpkg:
    name: Ubuntu (vcpkg)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '4f8fe05871555c1798dbcb1957d0d595e94f7b57'

      - name: Configure CMake
        run: cmake --preset vcpkg -DBUILD_TESTING=ON -DVCPKG_MANIFEST_FEATURES=tests

      - name: Verify protobuf linkage (vcpkg/static)
        run: |
          echo "FIND_PACKAGE_MESSAGE_DETAILS_Protobuf:"
          grep -E '^FIND_PACKAGE_MESSAGE_DETAILS_Protobuf:INTERNAL=' build-vcpkg/CMakeCache.txt
          grep -q 'libprotobuf\.a' build-vcpkg/CMakeCache.txt
          if grep -q -E 'libprotobuf\.(so|dylib)' build-vcpkg/CMakeCache.txt; then
            echo "Unexpected shared protobuf linkage in vcpkg build"
            exit 1
          fi

      - name: Build
        run: cmake --build --preset vcpkg --parallel $(nproc)

      - name: Run Tests
        working-directory: build-vcpkg
        run: ctest --output-on-failure --parallel $(nproc)

  # ===========================================================================
  # Windows with vcpkg (default preset / compatibility coverage)
  # ===========================================================================
  windows-vcpkg:
    name: Windows (MSVC, vcpkg default)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '4f8fe05871555c1798dbcb1957d0d595e94f7b57'

      - name: Configure CMake
        run: cmake --preset vcpkg -DBUILD_DOCS=OFF -DBUILD_TESTING=ON -DVCPKG_MANIFEST_FEATURES=tests

      - name: Report vcpkg triplet (windows default)
        shell: pwsh
        run: |
          $line = Select-String -Path "build-vcpkg/CMakeCache.txt" -Pattern '^VCPKG_TARGET_TRIPLET:STRING='
          if ($line) {
            $value = ($line.Line -split '=')[1]
            Write-Host "Configured triplet: $value"
          } else {
            Write-Host "VCPKG_TARGET_TRIPLET not explicitly set in CMakeCache.txt"
          }

      - name: Build
        run: cmake --build --preset vcpkg --parallel

      - name: Run Tests
        working-directory: build-vcpkg
        run: ctest -C Release --output-on-failure --parallel

  # ===========================================================================
  # Windows with vcpkg static-md (preferred packaging path)
  # ===========================================================================
  windows-vcpkg-static-md:
    name: Windows (MSVC, vcpkg static-md)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '4f8fe05871555c1798dbcb1957d0d595e94f7b57'

      - name: Configure CMake
        run: cmake --preset vcpkg-windows-static-md -DBUILD_DOCS=OFF -DBUILD_TESTING=ON -DVCPKG_MANIFEST_FEATURES=tests

      - name: Verify vcpkg triplet (windows)
        shell: pwsh
        run: |
          $line = Select-String -Path "build-vcpkg/CMakeCache.txt" -Pattern '^VCPKG_TARGET_TRIPLET:STRING='
          if (-not $line) { throw "VCPKG_TARGET_TRIPLET not found in CMakeCache.txt" }
          $value = ($line.Line -split '=')[1]
          Write-Host "Configured triplet: $value"
          if ($value -ne "x64-windows-static-md") {
            throw "Expected x64-windows-static-md, got $value"
          }

      - name: Build
        run: cmake --build --preset vcpkg-windows-static-md --parallel

      - name: Run Tests
        working-directory: build-vcpkg
        run: ctest -C Release --output-on-failure --parallel

  # ==========================================================================
  # macOS with vcpkg
  # ==========================================================================
  macos-vcpkg:
    name: macOS (vcpkg, ${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15
            arch: x64
          - runner: macos-14
            arch: arm64

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '4f8fe05871555c1798dbcb1957d0d595e94f7b57'

      - name: Configure CMake
        run: cmake --preset vcpkg -DBUILD_TESTING=ON -DVCPKG_MANIFEST_FEATURES=tests

      - name: Verify protobuf linkage (vcpkg/static)
        run: |
          echo "FIND_PACKAGE_MESSAGE_DETAILS_Protobuf:"
          grep -E '^FIND_PACKAGE_MESSAGE_DETAILS_Protobuf:INTERNAL=' build-vcpkg/CMakeCache.txt
          grep -q 'libprotobuf\.a' build-vcpkg/CMakeCache.txt
          if grep -q -E 'libprotobuf\.(so|dylib)' build-vcpkg/CMakeCache.txt; then
            echo "Unexpected shared protobuf linkage in vcpkg build"
            exit 1
          fi

      - name: Build
        run: cmake --build --preset vcpkg --parallel $(sysctl -n hw.ncpu)

      - name: Run Tests
        working-directory: build-vcpkg
        run: ctest --output-on-failure --parallel $(sysctl -n hw.ncpu)
