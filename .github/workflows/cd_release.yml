# SPDX-License-Identifier: MPL-2.0
# SPDX-FileCopyrightText: Copyright (c) 2026, Bayerische Motoren Werke Aktiengesellschaft (BMW AG)

name: Release

on:
  workflow_dispatch:
    inputs:
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  # ===========================================================================
  # Validate version and check tag
  # ===========================================================================
  validate:
    name: Validate
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: v${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version from vcpkg.json
        id: version
        run: |
          VERSION=$(jq -r '."version-string"' vcpkg.json)
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "::error::Could not read version-string from vcpkg.json"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Read version: $VERSION"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z]+\.[0-9]+)?$ ]]; then
            echo "::error::Invalid version format in vcpkg.json: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix.N (e.g., 1.0.0, 1.0.0-rc.1)"
            exit 1
          fi
          echo "Version validated: $VERSION"

      - name: Check tag does not exist
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "::error::Tag v$VERSION already exists"
            exit 1
          fi

  # ===========================================================================
  # Build with release artifacts (reuses ci_build.yml)
  # ===========================================================================
  build:
    name: Build
    needs: validate
    uses: ./.github/workflows/ci_build.yml
    with:
      release: true
      version: ${{ needs.validate.outputs.version }}

  # ===========================================================================
  # Create GitHub Release
  # ===========================================================================
  release:
    name: Create Release
    needs: [validate, build]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.validate.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, generating changelog from all commits"
            RANGE="HEAD"
          else
            echo "Generating changelog from $PREV_TAG to HEAD"
            RANGE="$PREV_TAG..HEAD"
          fi

          # Generate changelog grouped by type
          {
            echo "## What's Changed"
            echo ""

            # Features
            FEATURES=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^feat" 2>/dev/null || true)
            if [ -n "$FEATURES" ]; then
              echo "### Features"
              echo "$FEATURES"
              echo ""
            fi

            # Bug Fixes
            FIXES=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^fix" 2>/dev/null || true)
            if [ -n "$FIXES" ]; then
              echo "### Bug Fixes"
              echo "$FIXES"
              echo ""
            fi

            # Performance
            PERF=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^perf" 2>/dev/null || true)
            if [ -n "$PERF" ]; then
              echo "### Performance"
              echo "$PERF"
              echo ""
            fi

            # Documentation
            DOCS=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^docs" 2>/dev/null || true)
            if [ -n "$DOCS" ]; then
              echo "### Documentation"
              echo "$DOCS"
              echo ""
            fi

            # Full changelog link
            if [ -n "$PREV_TAG" ]; then
              echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREV_TAG...v$VERSION"
            fi
          } > changelog.md

          cat changelog.md

      - name: Create Git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          name: v${{ needs.validate.outputs.version }}
          body_path: changelog.md
          prerelease: ${{ inputs.prerelease }}
          files: |
            artifacts/*
          fail_on_unmatched_files: true
