# Building

This document provides detailed build instructions for all supported platforms.

> **ðŸ“‹ Dependency Reference:** All package names for each platform are defined in
> [`.github/dependencies.yml`](../.github/dependencies.yml) â€” the single source of truth
> used by both CI workflows and this documentation.

## Prerequisites

### Compiler Requirements

| Platform | Minimum Compiler            |
| -------- | --------------------------- |
| Linux    | GCC 9+ or Clang 10+         |
| Windows  | MSVC 2019 (v142) or later   |
| macOS    | Xcode 12+ (Apple Clang 12+) |

### Required Tools

- **CMake** 3.16 or later
- **Git** (for cloning and submodules)
- **Doxygen** (optional, for documentation)
- **pkg-config** (Linux, required when not using vcpkg to locate LZ4/ZSTD)

## Installation Methods

This project supports two methods for dependency management:

- **Option A: vcpkg (Recommended)** - Automatic dependency management
- **Option B: Manual** - System package managers or manual installation

---

## Documentation (Doxygen)

Documentation is generated by a CMake target named `library_api_doc`. It is
enabled by default when Doxygen is available (`BUILD_DOCS=ON`).

```bash
git submodule update --init --recursive
cmake -B build -DBUILD_DOCS=ON
cmake --build build --target library_api_doc
```

Generated HTML is written to `doc/html/index.html`.

---

## Linux

### Option A: Using vcpkg (Recommended)

#### 1. Install Build Tools

**Debian/Ubuntu:**

```bash
sudo apt update
sudo apt install build-essential cmake git doxygen graphviz clang-format clang-tidy pkg-config
```

**Fedora/RHEL:**

```bash
sudo dnf install gcc-c++ cmake git doxygen graphviz clang-tools-extra pkgconf-pkg-config
```

#### 2. Install vcpkg

```bash
git clone https://github.com/microsoft/vcpkg ~/vcpkg
~/vcpkg/bootstrap-vcpkg.sh
echo 'export VCPKG_ROOT="$HOME/vcpkg"' >> ~/.bashrc
source ~/.bashrc
```

#### 3. Clone and Build

```bash
git clone --recurse-submodules https://github.com/Lichtblick-Suite/asam-osi-utilities.git
cd asam-osi-utilities
cmake --preset vcpkg-linux
cmake --build build -j$(nproc)
```

#### 4. Run Tests

```bash
ctest --test-dir build --output-on-failure -j$(nproc)
```

### Option B: Manual Dependencies

#### 1. Install All Dependencies

**Debian/Ubuntu:**

```bash
sudo apt update
sudo apt install build-essential cmake git doxygen \
    libprotobuf-dev protobuf-compiler pkg-config \
    liblz4-dev libzstd-dev libgtest-dev
```

**Fedora/RHEL:**

```bash
sudo dnf install gcc-c++ cmake git doxygen \
    protobuf-devel lz4-devel zstd-devel gtest-devel pkgconf-pkg-config
```

#### 2. Clone and Build

```bash
git clone --recurse-submodules https://github.com/Lichtblick-Suite/asam-osi-utilities.git
cd asam-osi-utilities
cmake -B build
cmake --build build -j$(nproc)
```

---

## Windows

### Option A: Using vcpkg (Recommended)

#### 1. Install Build Tools

Using `winget` (Windows Package Manager):

> **Note:** If `winget` fails while searching the `msstore` source (e.g. certificate/proxy issues),
> force the community repository with `--source winget` or disable the store source:
>
> - `winget source disable msstore`
> - Then re-run the install command.

```powershell
# PowerShell 7 (recommended for vcpkg)
winget install --id Microsoft.PowerShell --source winget

# CMake
winget install --id Kitware.CMake --source winget

# Git
winget install --id Git.Git --source winget

# Doxygen (optional, for documentation)
winget install --id DimitriVanHeesch.Doxygen --source winget

# Graphviz (optional, for Doxygen diagrams)
winget install --id Graphviz.Graphviz --source winget

# LLVM (optional, provides clang-format and clang-tidy)
winget install --id LLVM.LLVM --source winget

# Visual Studio 2022 Build Tools
winget install --id Microsoft.VisualStudio.2022.BuildTools --source winget `
    --override "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended"
```

> **Note:** Open a new terminal after installation to pick up PATH changes.

> **Graphviz on Windows (troubleshooting):** `dot.exe` must be runnable for Doxygen diagrams.
> Verify in PowerShell: `dot -V`.
>
> If `dot -V` works in PowerShell but fails in Git Bash/MSYS with an error like
> `error while loading shared libraries` and a missing `libltdl-7.dll`, install MSYS2 and the
> missing runtime, then add the MinGW runtime folder to your PATH:
>
> - Install MSYS2: `winget install --id MSYS2.MSYS2 --source winget`
> - In the **MSYS2 MinGW x64** shell:
>   - `pacman -Syu`
>   - `pacman -S --needed mingw-w64-x86_64-libtool`
> - Add `C:\msys64\mingw64\bin` to PATH (or copy `libltdl-7.dll` next to `dot.exe`).

#### 2. Install vcpkg

```powershell
git clone https://github.com/microsoft/vcpkg C:\vcpkg
C:\vcpkg\bootstrap-vcpkg.bat
[System.Environment]::SetEnvironmentVariable('VCPKG_ROOT', 'C:\vcpkg', 'User')
```

Open a new terminal to pick up the environment variable.

#### 3. Clone and Build

```powershell
git clone --recurse-submodules https://github.com/Lichtblick-Suite/asam-osi-utilities.git
cd asam-osi-utilities
cmake --preset vcpkg-windows
cmake --build build --config Release --parallel
```

#### 4. Run Tests

```powershell
ctest --test-dir build -C Release --output-on-failure
```

### Option B: Manual Dependencies

Manual dependency installation on Windows without vcpkg is significantly more complex and **not recommended**. You would need to:

1. Build protobuf from source
2. Build lz4 from source
3. Build zstd from source
4. Build googletest from source
5. Configure CMake to find all libraries

If you must use this approach, consider using [Conan](https://conan.io/) or building with CMake's FetchContent.

---

## macOS

### Option A: Using Homebrew

#### 1. Install Xcode Command Line Tools

```bash
xcode-select --install
```

#### 2. Install Dependencies with Homebrew

```bash
brew install cmake protobuf lz4 zstd googletest doxygen graphviz
```

#### 3. Clone and Build

```bash
git clone --recurse-submodules https://github.com/Lichtblick-Suite/asam-osi-utilities.git
cd asam-osi-utilities
cmake -B build
cmake --build build -j$(sysctl -n hw.ncpu)
```

#### 4. Run Tests

```bash
ctest --test-dir build --output-on-failure
```

### Option B: Using vcpkg

Follow the Linux vcpkg instructions, replacing `vcpkg-linux` with `vcpkg`:

```bash
git clone https://github.com/microsoft/vcpkg ~/vcpkg
~/vcpkg/bootstrap-vcpkg.sh
export VCPKG_ROOT="$HOME/vcpkg"
cmake --preset vcpkg
cmake --build build -j$(sysctl -n hw.ncpu)
```

---

## CMake Presets

The project includes CMake presets for common configurations:

| Preset          | Description                             |
| --------------- | --------------------------------------- |
| `default`       | Standard build without vcpkg            |
| `vcpkg`         | Build with vcpkg (auto-detect platform) |
| `vcpkg-linux`   | Build with vcpkg on Linux               |
| `vcpkg-windows` | Build with vcpkg on Windows (x64)       |

Use presets with:

```bash
cmake --preset <preset-name>
cmake --build build
```

---

## CMake Options

| Option           | Default | Description                     |
| ---------------- | ------- | ------------------------------- |
| `BUILD_EXAMPLES` | `ON`    | Build example programs          |
| `BUILD_TESTING`  | `ON`    | Build unit tests                |
| `CODE_COVERAGE`  | `OFF`   | Enable code coverage (GCC only) |

Example:

```bash
cmake -B build -DBUILD_EXAMPLES=OFF -DBUILD_TESTING=ON
```

---

## Troubleshooting

### vcpkg: First Build is Slow

The first build with vcpkg takes 10-15 minutes because it compiles protobuf, abseil, and other dependencies from source. Subsequent builds use vcpkg's binary cache.

### vcpkg: Configure Fails on Windows

If cmake configure fails, try:

1. Delete the `build` folder completely
2. Open a new terminal (ensure `VCPKG_ROOT` is set)
3. Run cmake configure again

```powershell
Remove-Item -Recurse -Force build
cmake --preset vcpkg-windows
```

### Corporate Proxy Issues

If vcpkg downloads fail behind a proxy:

**Windows:**

```powershell
netsh winhttp import proxy source=ie
```

**Linux/macOS:**

```bash
export HTTP_PROXY=http://proxy:port
export HTTPS_PROXY=http://proxy:port
```

### Protobuf Version Mismatch

If you see protobuf-related errors, ensure you're not mixing system protobuf with vcpkg protobuf. Use one method consistently.

### Submodules Not Initialized

If you see missing file errors:

```bash
git submodule update --init --recursive
```

---

## Next Steps

- [Development Setup](development.md) - Configure your development environment
- [Examples](../examples/README.md) - Learn how to use the library
