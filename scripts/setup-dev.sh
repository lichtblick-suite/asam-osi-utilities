#!/bin/bash
#
# SPDX-FileCopyrightText: Copyright (c) 2026, Bayerische Motoren Werke Aktiengesellschaft (BMW AG)
# SPDX-License-Identifier: MPL-2.0
#
# Setup development environment for ASAM OSI Utilities
# This script uses native Git hooks - no Python required

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "=============================================="
echo "ASAM OSI Utilities - Development Setup"
echo "=============================================="
echo ""
echo "Note: On Windows, run this script from Git Bash or via: bash scripts/setup-dev.sh"
echo ""

# Check for required C++ tools
echo "Checking required tools..."
echo ""

# Check for clang-format
if command -v clang-format &> /dev/null; then
    echo "✓ clang-format found: $(clang-format --version | head -n1)"
else
    echo "WARNING: clang-format not found (optional, for code formatting)"
    echo "  Install via: apt install clang-format (Debian/Ubuntu)"
    echo "           or: brew install clang-format (macOS)"
fi

# Check for CMake
if command -v cmake &> /dev/null; then
    echo "✓ CMake found: $(cmake --version | head -n1)"
else
    echo "WARNING: CMake not found"
    echo "  Install via: apt install cmake (Debian/Ubuntu)"
    echo "           or: brew install cmake (macOS)"
fi

# Check for Ninja (recommended for compile_commands.json on Windows, if using Git Bash)
if command -v ninja &> /dev/null; then
    echo "✓ Ninja found: $(ninja --version)"
else
    echo "WARNING: Ninja not found (recommended for clangd on Windows)"
    echo "  Install via: winget install Ninja-build.Ninja (Windows, for Git Bash users)"
fi


# Install Git hooks
echo ""
echo "Installing Git hooks..."
HOOKS_DIR="$REPO_ROOT/.git/hooks"
mkdir -p "$HOOKS_DIR"

# Create pre-commit hook
cat > "$HOOKS_DIR/pre-commit" << 'EOF'
#!/bin/sh
# Auto-generated by setup-dev.sh - Native Git pre-commit hook
# Works on Linux, macOS, and Windows (Git Bash)
#
# Usage:
#   .git/hooks/pre-commit                               # Check staged files only (format only by default)
#   .git/hooks/pre-commit --all-files                   # Check all C++ files in the project
#   .git/hooks/pre-commit --run-tidy                    # Run clang-tidy (check only)
#   .git/hooks/pre-commit --fix-format                  # Auto-fix formatting issues
#   .git/hooks/pre-commit --fix-tidy                    # Auto-fix clang-tidy issues
#   .git/hooks/pre-commit --skip-tests                  # Skip tests/ in checks
#   .git/hooks/pre-commit --skip-format                 # Skip clang-format checks
#   .git/hooks/pre-commit --skip-tidy                   # Skip clang-tidy checks
#   .git/hooks/pre-commit --all-files --run-tidy --fix-format --fix-tidy --skip-tests
#
# Notes:
#   - When using --run-tidy/--fix-tidy, clang-format is skipped unless --fix-format is provided.

ALL_FILES=0
FIX_FORMAT=0
FIX_TIDY=0
RUN_TIDY=0
SKIP_TESTS=0
SKIP_FORMAT=0
SKIP_TIDY=0
for arg in "$@"; do
    case "$arg" in
        --all-files) ALL_FILES=1 ;;
        --run-tidy) RUN_TIDY=1 ;;
        --fix-format) FIX_FORMAT=1 ;;
        --fix-tidy) FIX_TIDY=1; RUN_TIDY=1 ;;
        --skip-tests) SKIP_TESTS=1 ;;
        --skip-format) SKIP_FORMAT=1 ;;
        --skip-tidy) SKIP_TIDY=1 ;;
    esac
done
if [ $SKIP_TIDY -eq 1 ]; then
    RUN_TIDY=0
fi

RUN_FORMAT=1
if [ $SKIP_FORMAT -eq 1 ]; then
    RUN_FORMAT=0
fi
# If the user explicitly requested clang-tidy, only run formatting when asked.
if [ $RUN_TIDY -eq 1 ] && [ $FIX_FORMAT -eq 0 ]; then
    RUN_FORMAT=0
fi

# Determine search roots based on skip flags
if [ $SKIP_TESTS -eq 1 ]; then
    SEARCH_DIRS="src include examples"
    ROOT_REGEX="^(src|include|examples)/"
else
    SEARCH_DIRS="src include tests examples"
    ROOT_REGEX="^(src|include|tests|examples)/"
fi

# Get list of C++ files to check
if [ $RUN_FORMAT -eq 1 ]; then
    if [ $ALL_FILES -eq 1 ]; then
        if [ $SKIP_TESTS -eq 1 ]; then
            echo "Checking all C++ files (excluding tests)..."
        else
            echo "Checking all C++ files..."
        fi
        FILES=$(find $SEARCH_DIRS -type f \( -name "*.cpp" -o -name "*.cc" -o -name "*.cxx" -o -name "*.c++" -o -name "*.h" -o -name "*.hpp" -o -name "*.c" \) 2>/dev/null | grep -v "^lib/")
    else
        FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "${ROOT_REGEX}.*\\.(cpp|cc|cxx|c\\+\\+|h|hpp|c)$" | grep -v "^lib/")
    fi

    if [ -n "$FILES" ]; then
        if [ $FIX_FORMAT -eq 1 ]; then
            echo "Auto-fixing code formatting..."
        else
            echo "Checking code formatting..."
        fi
        FAILED=0
        for FILE in $FILES; do
            if command -v clang-format &> /dev/null; then
                if [ $FIX_FORMAT -eq 1 ]; then
                    clang-format -i "$FILE" 2>/dev/null
                    if [ $ALL_FILES -eq 0 ]; then
                        git add "$FILE"
                    fi
                else
                    if ! clang-format --dry-run --Werror "$FILE" 2>/dev/null; then
                        echo "  ✗ $FILE needs formatting"
                        FAILED=1
                    fi
                fi
            fi
        done
        if [ $FIX_FORMAT -eq 1 ]; then
            echo "✓ Code formatting fixed"
        else
            if [ $FAILED -ne 0 ]; then
                echo ""
                echo "Please run: .git/hooks/pre-commit --fix-format"
                exit 1
            fi
            echo "✓ Code formatting OK"
        fi
    else
        if [ $ALL_FILES -eq 1 ]; then
            echo "No C++ files found to check."
        fi
    fi
else
    if [ $SKIP_FORMAT -eq 1 ]; then
        echo "Skipping clang-format checks (--skip-format)"
    else
        echo "Skipping clang-format checks (tidy-only run; use --fix-format to include)"
    fi
fi

# Run clang-tidy (lint) when available
if command -v clang-tidy-18 &> /dev/null; then
    CLANG_TIDY_BIN="clang-tidy-18"
elif command -v clang-tidy &> /dev/null; then
    CLANG_TIDY_BIN="clang-tidy"
else
    CLANG_TIDY_BIN=""
fi

if [ $RUN_TIDY -eq 1 ]; then
    if [ -n "$CLANG_TIDY_BIN" ]; then
        if [ -f "build-tests/compile_commands.json" ]; then
            COMPILE_DIR="build-tests"
        elif [ -f "build/compile_commands.json" ]; then
            COMPILE_DIR="build"
        elif [ -f "build-ninja/compile_commands.json" ]; then
            COMPILE_DIR="build-ninja"
        else
            COMPILE_DIR=""
        fi

        if [ -n "$COMPILE_DIR" ]; then
            if [ $ALL_FILES -eq 1 ]; then
                TIDY_FILES=$(find $SEARCH_DIRS -type f \( -name "*.cpp" -o -name "*.cc" -o -name "*.cxx" -o -name "*.c++" \) 2>/dev/null | grep -v "^lib/")
            else
                TIDY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "${ROOT_REGEX}.*\\.(cpp|cc|cxx|c\\+\\+)$" | grep -v "^lib/")
            fi

            if [ -n "$TIDY_FILES" ]; then
                if [ $FIX_TIDY -eq 1 ]; then
                    echo "Running clang-tidy (auto-fix)..."
                else
                    echo "Running clang-tidy..."
                fi
                LINT_FAILED=0
                for FILE in $TIDY_FILES; do
                    if [ $FIX_TIDY -eq 1 ]; then
                        if ! "$CLANG_TIDY_BIN" -p "$COMPILE_DIR" --warnings-as-errors='*' --fix --fix-errors "$FILE"; then
                            LINT_FAILED=1
                        fi
                        if [ $ALL_FILES -eq 0 ]; then
                            git add "$FILE"
                        fi
                    else
                        if ! "$CLANG_TIDY_BIN" -p "$COMPILE_DIR" --warnings-as-errors='*' "$FILE"; then
                            LINT_FAILED=1
                        fi
                    fi
                done
                if [ $LINT_FAILED -ne 0 ]; then
                    if [ $FIX_TIDY -eq 0 ]; then
                        echo ""
                        echo "Please run: .git/hooks/pre-commit --fix-tidy"
                    fi
                    exit 1
                fi
                echo "✓ clang-tidy OK"
            fi
        else
            echo "clang-tidy skipped (no compile_commands.json found). Build once to generate it."
        fi
    else
        echo "clang-tidy not found, skipping lint"
    fi
else
    if [ $SKIP_TIDY -eq 1 ]; then
        echo "Skipping clang-tidy checks (--skip-tidy)"
    else
        echo "Skipping clang-tidy checks (disabled by default; use --run-tidy or --fix-tidy)"
    fi
fi

exit 0
EOF
chmod +x "$HOOKS_DIR/pre-commit"
echo "✓ Pre-commit hook installed"

# Create commit-msg hook
cat > "$HOOKS_DIR/commit-msg" << 'EOF'
#!/bin/sh
# Auto-generated by setup-dev.sh - Native Git commit-msg hook

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Check DCO sign-off
if ! echo "$COMMIT_MSG" | grep -q "^Signed-off-by: "; then
    echo "ERROR: Commit message must include DCO sign-off"
    echo ""
    echo "Add sign-off with: git commit -s -m \"message\""
    echo "Or amend: git commit --amend -s"
    exit 1
fi

# Check conventional commit format (skip merge/revert commits)
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n1)
if ! echo "$FIRST_LINE" | grep -qE "^(Merge|Revert)"; then
    if ! echo "$FIRST_LINE" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|ci|perf|build)(\([a-zA-Z0-9_-]+\))?: .+"; then
        echo "ERROR: Commit message must follow Conventional Commits format"
        echo ""
        echo "Format: <type>(<scope>): <description>"
        echo "Types: feat, fix, docs, style, refactor, test, chore, ci, perf, build"
        echo ""
        echo "Example: feat(mcap): add compression support"
        exit 1
    fi
fi

echo "✓ Commit message OK"
exit 0
EOF
chmod +x "$HOOKS_DIR/commit-msg"
echo "✓ Commit-msg hook installed"

# Check Git configuration for signing
echo ""
echo "=============================================="
echo "Git Configuration for Signed Commits"
echo "=============================================="

# Check for user.name and user.email
GIT_NAME=$(git config --get user.name || echo "")
GIT_EMAIL=$(git config --get user.email || echo "")

if [ -z "$GIT_NAME" ]; then
    echo "WARNING: Git user.name is not set"
    echo "  Run: git config --global user.name \"Your Name\""
else
    echo "✓ Git user.name: $GIT_NAME"
fi

if [ -z "$GIT_EMAIL" ]; then
    echo "WARNING: Git user.email is not set"
    echo "  Run: git config --global user.email \"your.email@example.com\""
else
    echo "✓ Git user.email: $GIT_EMAIL"
fi

# Check for GPG signing configuration
GPG_SIGN=$(git config --get commit.gpgsign || echo "false")
GPG_KEY=$(git config --get user.signingkey || echo "")

echo ""
if [ "$GPG_SIGN" = "true" ]; then
    echo "✓ GPG signing is enabled"
    if [ -n "$GPG_KEY" ]; then
        echo "✓ GPG signing key: $GPG_KEY"
    else
        echo "WARNING: GPG signing is enabled but no key is set"
        echo "  Run: git config --global user.signingkey YOUR_KEY_ID"
    fi
else
    echo "INFO: GPG signing is not enabled"
    echo ""
    echo "To enable GPG signed commits (recommended):"
    echo "  1. Generate a GPG key: gpg --full-generate-key"
    echo "  2. List keys: gpg --list-secret-keys --keyid-format=long"
    echo "  3. Configure Git:"
    echo "     git config --global user.signingkey YOUR_KEY_ID"
    echo "     git config --global commit.gpgsign true"
    echo "  4. Add key to GitHub: https://github.com/settings/keys"
fi

echo ""
echo "=============================================="
echo "Setup Complete!"
echo "=============================================="
echo ""
echo "You can now start developing. Remember:"
echo "  - Sign off commits: git commit -s -m \"message\""
echo "  - GPG sign commits: git commit -S -s -m \"message\""
echo "  - Run checks on all files: .git/hooks/pre-commit --all-files"
echo "  - Run clang-tidy checks: .git/hooks/pre-commit --run-tidy (or --all-files --run-tidy)"
echo "  - Auto-fix formatting: .git/hooks/pre-commit --fix-format (or --all-files --fix-format)"
echo "  - Auto-fix clang-tidy: .git/hooks/pre-commit --fix-tidy (or --all-files --fix-tidy)"
echo "  - Skip tests: .git/hooks/pre-commit --skip-tests"
echo "  - Note: --run-tidy/--fix-tidy skips clang-format unless --fix-format is also set"
